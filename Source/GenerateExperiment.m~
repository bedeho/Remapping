
%
%  GenerateExperiment.m
%  Remapping
%
%  Created by Bedeho Mender on 19/05/13.
%  Copyright 2013 OFTNAI. All rights reserved.
%

function GenerateExperiment()

    % Import global variables
    declareGlobalVars();
    global EXPERIMENTS_FOLDER;

    % Experiment parameters
    Name = 'test';
    experimentFolderPath = [EXPERIMENTS_FOLDER Name];
    
    % Stimuli
    %trainingStimuli = 'dddd';
    %testingStimuli = 'dddd';
    
    % Create experiment folders
    if exist(experimentFolderPath),
        
        choice = ;
        
        if strcmp(questdlg('DELETE OLD EXPERIMENT?', 'Delete', 'NO','YES','NO'), ',
            return;
        else
            rmdir(experimentFolderPath);
        end   
    end
    
    mkdir(experimentFolderPath);
    
    %% Specify main paramters
    parameters = containers.Map
    
    % LIP
    parameters('R_eccentricity') = [45 50];
    parameters('R_tau')          = [0.100 0.2]; % (s)
    parameters('C_to_R_psi')     = [0.08]; % 0.15
    parameters('R_w_INHB')       = [0]; %0.7
    parameters('V_tau')          = [0.400]; % (s)
    parameters('V_psi')          = [4];
    parameters('V_sigma')        = [5]; % (deg) receptive field size
    parameters('C_to_R_alpha')   = [0.1]; % learning rate
    parameters('R_slope')        = [10];
    parameters('R_threshold')    = [2.0];
    
    % FEF: Saccade Plan
    parameters('S_eccentricity') = [30];
    parameters('S_delay_sigma')  = [0.4]; % (s)
    parameters('S_tau')          = [0.300]; % (s)
    parameters('S_psi')          = [1];
    parameters('S_sigma')        = parameters('V_sigma'); % (deg) receptive field size
    parameters('S_slope')        = [6];
    parameters('S_threshold')    = [0.2];
    
    % SC?: Comb
    parameters('C_tau')          = [0.100]; % (s)
    parameters('R_to_C_psi')     = [1.0];
    parameters('S_to_C_psi')     = [6.2];
    parameters('C_w_INHB')       = [0]; %/C_N
    parameters('R_to_C_alpha')   = [0.1]; % learning rate
    parameters('S_to_C_alpha')   = [0.1]; % learning rate
    parameters('C_slope')        = [50];
    parameters('C_threshold')    = [1.0];
    
    % Save the experiment params
    save([experimentFolderPath filesep 'GenerateExperiment.mat'] , 'parameters');
    
    % Start paramters permutation
    simulation = containers.Map;
    nameComponents = cell(1, length(parameters.keys));
    valueComponents = cell(1, length(parameters.keys));
    permute(1);

    %% Generate simulations
    function permute(paramnr)
        
        keys = parameters.keys;
        
        % Are we done
        if paramnr <= length(keys),
            
            key = keys{paramnr}
            values = parameters(key);
            
            % Add to name
            if length(values) > 1,
                nameComponents{paramnr} = key;
                valueComponents{paramnr} = values;
            end
            
            for v=values,
                simulation(key) = v;
                permute(paramnr+1);
            end
        else
            
            % Make name
            simulationName = '';
            for p=1:length(nameComponents),
                
                if ~isempty(nameComponents{p}),
                    simulationName = [simulationName '-' nameComponents{p} '=' num2str(valueComponents{p})];
                end
            end
            
            % If there is only one param combination, then just name it
            % blank
            if isempty(simulationName),
                simulationName = 'baseline';
            end
            
            % Create simulation folder
            simulationFolder = [experimentFolderPath filesep simulationName];
            mkdir(simulationFolder);
            
            % Derive new paramters
            simulation('R_preferences')         = -simulation('R_eccentricity'):1:simulation('R_eccentricity');
            S_preferences                       = -simulation('S_eccentricity'):1:simulation('S_eccentricity');
            offset                              = 0.4*randn(1, length(S_preferences)); % (s)
            offset(offset < 0)                  = -offset(offset < 0);
            simulation('S_presaccadicOffset')   = offset;
            
            % Save params
            save([simulationFolder filesep 'SimulationExperiment.mat'] , 'simulation');
            
            % Create simulation blank network
            createBlankNetwork(simulationFolder, parameters);
            
            % Run experiment
            %Remapping()
            
        end
    end
    
end